<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DASHBOARD - Districk KUPANG</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { 
      margin:0; 
      font-family:Arial, sans-serif; 
      background:#f4f6f9;
      padding-top: 80px;
    }
    header {
      background:#c60000; 
      color:#fff; 
      padding:15px 20px;
      text-align:center; 
      font-size:20px; 
      font-weight:bold;
      display:flex; 
      align-items:center; 
      justify-content:space-between;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    header img { 
      height:50px; 
      border-radius:6px; 
      margin-right: 15px;
    }
    .header-title {
      flex-grow: 1;
    }
    .header-right {
      width: 65px;
    }
    .sidebar {
      position:fixed; 
      top:80px; 
      left:0; 
      width:220px; 
      height:calc(100% - 80px);
      background:#000000; 
      padding-top:20px;
      overflow-y: auto;
    }
    .sidebar a {
      display:block; 
      color:#fff; 
      padding:12px 20px;
      text-decoration:none; 
      font-size:16px;
      transition: all 0.3s ease;
    }
    .sidebar a:hover { 
      background:#1abc9c; 
      padding-left: 25px;
    }
    .sidebar a i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    .content { 
      margin-left:220px; 
      padding:20px; 
    }
    .card {
      background:#fff; 
      padding:20px; 
      margin-bottom:20px;
      border-radius:8px; 
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    h2 {
      color: #c60000;
      border-bottom: 2px solid #c60000;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    h3 {
      color: #333;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    .settings-section {
      margin-bottom: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #c60000;
    }
    .settings-section h3 {
      margin-top: 0;
      color: #c60000;
    }
    .table-wrapper {
      margin-top: 15px;
    }
    .tools-container {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 20;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .table-container {
      max-height: 500px;
      overflow-y: auto;
    }
    table { 
      width:100%; 
      border-collapse:collapse; 
      font-size:14px; 
      white-space: nowrap;
    }
    table th, table td {
      border:1px solid #ccc; 
      padding:8px;
      text-align: left;
    }
    table th { 
      background:#c60000;
      color:#fff; 
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
      text-align: center;
    }
    table tr:nth-child(even) { 
      background:#f9f9f9; 
    }
    table tr:hover {
      background: #e8f4fc;
    }
    .text-center {
      text-align: center;
    }
    .text-left {
      text-align: left;
    }
    .tools { 
      display:flex; 
      gap:20px; 
      align-items:center; 
      flex-wrap:wrap;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
    }
    .tools label { 
      font-weight:bold; 
      margin-right:8px; 
      color: #333;
    }
    .tools input, .tools select { 
      padding:8px; 
      font-size:14px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .tools input:focus, .tools select:focus {
      outline: none;
      border-color: #c60000;
      box-shadow: 0 0 5px rgba(198, 0, 0, 0.3);
    }
    .pagination { 
      margin-top:15px; 
      text-align:center; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pagination button {
      padding:8px 15px; 
      margin:0 5px;
      border:none; 
      border-radius:4px;
      background:#2c3e50; 
      color:#fff; 
      cursor:pointer;
      transition: all 0.3s ease;
    }
    .pagination button:hover {
      background: #1abc9c;
    }
    .pagination button:disabled { 
      background:#aaa; 
      cursor:not-allowed; 
    }
    .pagination-controls {
      display: flex;
      align-items: center;
    }
    .pagination-info {
      flex-grow: 1;
      text-align: center;
    }
    .rows-per-page {
      display: flex;
      align-items: center;
    }
    input[type="file"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f8f9fa;
      cursor: pointer;
    }
    input[type="file"]:hover {
      background: #e9ecef;
    }
    .dropdown-arrow {
      position: relative;
      display: inline-block;
    }
    .dropdown-arrow::after {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-pending {
      background-color: #f39c12;
      color: white;
    }
    .status-approved {
      background-color: #27ae60;
      color: white;
    }
    .status-rejected {
      background-color: #e74c3c;
      color: white;
    }
    .status-returned {
      background-color: #3498db;
      color: white;
    }
    .status-canceled {
      background-color: #95a5a6;
      color: white;
    }
    .status-invoiced {
      background-color: #9b59b6;
      color: white;
    }
    .status-completed {
      background-color: #27ae60;
      color: white;
    }
    .status-printed {
      background-color: #34495e;
      color: white;
    }
    .status-wip {
      background-color: #f39c12;
      color: white;
    }
    .status-wip-comp {
      background-color: #e67e22;
      color: white;
    }
    .status-wip-tech {
      background-color: #16a085;
      color: white;
    }
    .filter-value {
      margin-left: 10px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 80px;
    }
    .notification {
      position: fixed;
      top: 90px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1001;
      display: none;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .btn {
      padding: 8px 15px;
      background: #c60000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }
    .btn:hover {
      background: #a30000;
    }
    .btn-success {
      background: #27ae60;
    }
    .btn-success:hover {
      background: #219653;
    }
    .btn-danger {
      background: #e74c3c;
    }
    .btn-danger:hover {
      background: #c0392b;
    }
    .file-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    /* Loading animation */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #c60000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Statistics styles */
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 140px;
      border-left: 4px solid #c60000;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    .stat-card h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 14px;
      font-weight: 600;
    }
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #c60000;
    }
    .stat-card.total {
      border-left-color: #2c3e50;
    }
    .stat-card.total .stat-value {
      color: #2c3e50;
    }
    .stat-card.canceled {
      border-left-color: #95a5a6;
    }
    .stat-card.canceled .stat-value {
      color: #95a5a6;
    }
    .stat-card.invoiced {
      border-left-color: #9b59b6;
    }
    .stat-card.invoiced .stat-value {
      color: #9b59b6;
    }
    .stat-card.completed {
      border-left-color: #27ae60;
    }
    .stat-card.completed .stat-value {
      color: #27ae60;
    }
    .stat-card.printed {
      border-left-color: #34495e;
    }
    .stat-card.printed .stat-value {
      color: #34495e;
    }
    .stat-card.wip {
      border-left-color: #f39c12;
    }
    .stat-card.wip .stat-value {
      color: #f39c12;
    }
    .stat-card.wip-comp {
      border-left-color: #e67e22;
    }
    .stat-card.wip-comp .stat-value {
      color: #e67e22;
    }
    .stat-card.wip-tech {
      border-left-color: #16a085;
    }
    .stat-card.wip-tech .stat-value {
      color: #16a085;
    }
    /* Filter section styles */
    .filter-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #c60000;
    }
    .filter-section h4 {
      margin: 0 0 10px 0;
      color: #c60000;
      font-size: 16px;
    }
    .filter-row {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-group label {
      font-weight: bold;
      color: #333;
      white-space: nowrap;
    }
    .filter-group input, .filter-group select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .filter-group input:focus, .filter-group select:focus {
      outline: none;
      border-color: #c60000;
      box-shadow: 0 0 5px rgba(198, 0, 0, 0.3);
    }
    .clear-filters {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }
    .clear-filters:hover {
      background: #c0392b;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <img id="logo" src="" alt="Logo">
    </div>
    <div class="header-title">
      <span>DASHBOARD - Districk KUPANG</span>
    </div>
    <div class="header-right">
      <!-- Ruang kosong untuk keseimbangan -->
    </div>
  </header>

  <div class="sidebar">
    <a href="#" onclick="showPage('master')"><i class="fas fa-cogs"></i> Master Komponen</a>
    <a href="#" onclick="showPage('stock')"><i class="fas fa-boxes"></i> Stock Komponen</a>
    <a href="#" onclick="showPage('reservasi')"><i class="fas fa-calendar-check"></i> Reservasi</a>
    <a href="#" onclick="showPage('service')"><i class="fas fa-headset"></i> Service Calls</a>
    <a href="#" onclick="showPage('settings')"><i class="fas fa-cog"></i> Pengaturan</a>
    <a href="#" onclick="showPage('logout')"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <div class="content">
    <!-- MASTER KOMPONEN -->
    <div id="master" class="card">
      <h2><i class="fas fa-cogs"></i> Master Komponen</h2>
      
      <!-- Statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <h4>Total Komponen</h4>
          <div class="stat-value" id="masterTotalCount">0</div>
        </div>
      </div>

      <!-- Import Excel -->
      <h3><i class="fas fa-file-excel"></i> Import File Excel</h3>
      <input type="file" id="importMaster" accept=".xlsx,.xls,.csv" onchange="importMasterExcel()" />

      <!-- Wrapper untuk tabel dan tools -->
      <div class="table-wrapper">
        <!-- Tools container yang sticky -->
        <div class="tools-container">
          <!-- Pencarian + Filter -->
          <div class="tools">
            <div>
              <label for="searchMaster"><i class="fas fa-search"></i> Cari:</label>
              <input type="text" id="searchMaster" placeholder="Part Number / Description" onkeyup="applyMasterFilter()" />
            </div>
            <div>
              <label for="filterPart"><i class="fas fa-filter"></i> Filter Part Number:</label>
              <select id="filterPart" onchange="applyMasterFilter()">
                <option value="all">Semua</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tabel dengan container -->
        <div class="table-container">
          <table id="masterTable">
            <thead>
              <tr>
                <th>No.</th>
                <th>Part Number</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-controls">
          <button id="prevMaster" onclick="prevMasterPage()"><i class="fas fa-arrow-left"></i> Back</button>
        </div>
        <div class="pagination-info">
          <span id="pageInfoMaster"></span>
        </div>
        <div class="rows-per-page">
          <label for="rowsPerPageMaster">Baris per halaman:</label>
          <select id="rowsPerPageMaster" onchange="changeRowsPerPageMaster()">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
          <button id="nextMaster" onclick="nextMasterPage()">Next <i class="fas fa-arrow-right"></i></button>
        </div>
      </div>
    </div>

    <!-- STOCK SPAREPART -->
    <div id="stock" class="card" style="display:none;">
      <h2><i class="fas fa-boxes"></i> Data Stock Komponen</h2>
      
      <!-- Statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <h4>Total Stok</h4>
          <div class="stat-value" id="stockTotalCount">0</div>
        </div>
        <div class="stat-card">
          <h4>Available QTY</h4>
          <div class="stat-value" id="stockAvailableCount">0</div>
        </div>
        <div class="stat-card">
          <h4>QTY Alloc</h4>
          <div class="stat-value" id="stockAllocCount">0</div>
        </div>
      </div>

      <!-- Import Excel -->
      <h3><i class="fas fa-file-excel"></i> Import File Excel</h3>
      <input type="file" id="importFile" accept=".xlsx,.xls,.csv" onchange="importExcel()" />
      
      <!-- Download Excel -->
      <div class="file-actions">
        <button class="btn btn-success" onclick="exportStockToExcel()">
          <i class="fas fa-download"></i> Download Excel
        </button>
      </div>

      <!-- Wrapper untuk tabel dan tools -->
      <div class="table-wrapper">
        <!-- Tools container yang sticky -->
        <div class="tools-container">
          <div class="tools">
            <div>
              <label for="filterLokasi"><i class="fas fa-filter"></i> Filter Tipe Lokasi:</label>
              <select id="filterLokasi" onchange="applyFilter()">
                <option value="all">Semua</option>
              </select>
            </div>
            <div>
              <label for="searchInput"><i class="fas fa-search"></i> Cari:</label>
              <input type="text" id="searchInput" placeholder="Nama / Part / Deskripsi" onkeyup="applyFilter()" />
            </div>
          </div>
        </div>

        <!-- Tabel dengan container -->
        <div class="table-container">
          <table id="stockTable">
            <thead>
              <tr>
                <th>No.</th>
                <th>Tipe Lokasi</th>
                <th>Nama</th>
                <th>Part</th>
                <th>Deskripsi Part</th>
                <th>QTY</th>
                <th>QTY Alloc</th>
                <th>Available QTY</th>
                <th>Return To Factory</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="pagination">
        <div class="pagination-controls">
          <button id="prevBtn" onclick="prevPage()"><i class="fas fa-arrow-left"></i> Back</button>
        </div>
        <div class="pagination-info">
          <span id="pageInfo"></span>
        </div>
        <div class="rows-per-page">
          <label for="rowsPerPage">Baris per halaman:</label>
          <select id="rowsPerPage" onchange="changeRowsPerPage()">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
          <button id="nextBtn" onclick="nextPage()">Next <i class="fas fa-arrow-right"></i></button>
        </div>
      </div>
    </div>

    <!-- RESERVASI -->
    <div id="reservasi" class="card" style="display:none;">
      <h2><i class="fas fa-calendar-check"></i> Reservasi Komponen</h2>
      
      <!-- Statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <h4>Total Reservasi</h4>
          <div class="stat-value" id="reservasiTotalCount">0</div>
        </div>
        <div class="stat-card">
          <h4>Qty Reservasi</h4>
          <div class="stat-value" id="reservasiQtyCount">0</div>
        </div>
        <div class="stat-card">
          <h4>Qty Close</h4>
          <div class="stat-value" id="reservasiCloseCount">0</div>
        </div>
      </div>

      <h3><i class="fas fa-file-excel"></i> Import File Excel</h3>
      <input type="file" id="importReservasi" accept=".xlsx,.xls,.csv" onchange="importReservasiExcel()" />
      
      <!-- Download Excel -->
      <div class="file-actions">
        <button class="btn btn-success" onclick="exportReservasiToExcel()">
          <i class="fas fa-download"></i> Download Excel
        </button>
      </div>
      
      <!-- Filter Section -->
      <div class="filter-section">
        <h4><i class="fas fa-filter"></i> Filter Data</h4>
        <div class="filter-row">
          <div class="filter-group">
            <label for="searchReservasi"><i class="fas fa-search"></i> Cari:</label>
            <input type="text" id="searchReservasi" placeholder="Nomor / Catatan / Part" onkeyup="applyReservasiFilter()" />
          </div>
          <div class="filter-group">
            <label for="filterTeknisi"><i class="fas fa-user"></i> Teknisi:</label>
            <select id="filterTeknisi" onchange="applyReservasiFilter()">
              <option value="all">Semua</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterSerial"><i class="fas fa-barcode"></i> Serial Number:</label>
            <input type="text" id="filterSerial" placeholder="Masukkan Serial Number" onkeyup="applyReservasiFilter()" />
          </div>
          <button class="clear-filters" onclick="clearReservasiFilters()">
            <i class="fas fa-times"></i> Hapus Filter
          </button>
        </div>
      </div>
      
      <!-- Wrapper untuk tabel dan tools -->
      <div class="table-wrapper">
        <!-- Tabel dengan container -->
        <div class="table-container">
          <table id="reservasiTable">
            <thead>
              <tr>
                <th>Nomor</th>
                <th>Catatan</th>
                <th>Part</th>
                <th>Qty Reservasi</th>
                <th>Qty Transaksi</th>
                <th>Qty Close</th>
                <th>Part Demand</th>
                <th>Serial Number</th>
                <th>Return To Factory</th>
                <th>Teknisi Perbaikan</th>
                <th>Analisa SA</th>
                <th>Disetujui Pada</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="pagination">
        <div class="pagination-controls">
          <button id="prevReservasi" onclick="prevReservasiPage()"><i class="fas fa-arrow-left"></i> Back</button>
        </div>
        <div class="pagination-info">
          <span id="pageInfoReservasi"></span>
        </div>
        <div class="rows-per-page">
          <label for="rowsPerPageReservasi">Baris per halaman:</label>
          <select id="rowsPerPageReservasi" onchange="changeRowsPerPageReservasi()">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
          <button id="nextReservasi" onclick="nextReservasiPage()">Next <i class="fas fa-arrow-right"></i></button>
        </div>
      </div>
    </div>

    <!-- SERVICE CALLS -->
    <div id="service" class="card" style="display:none;">
      <h2><i class="fas fa-headset"></i> Service Calls</h2>
      
      <!-- Statistics - Updated with all status types -->
      <div class="stats-container">
        <div class="stat-card total">
          <h4>SEMUA</h4>
          <div class="stat-value" id="serviceTotalCount">0</div>
        </div>
        <div class="stat-card canceled">
          <h4>CANCELED</h4>
          <div class="stat-value" id="serviceCanceledCount">0</div>
        </div>
        <div class="stat-card invoiced">
          <h4>INVOICED</h4>
          <div class="stat-value" id="serviceInvoicedCount">0</div>
        </div>
        <div class="stat-card completed">
          <h4>COMPLETED</h4>
          <div class="stat-value" id="serviceCompletedCount">0</div>
        </div>
        <div class="stat-card printed">
          <h4>PRINTED</h4>
          <div class="stat-value" id="servicePrintedCount">0</div>
        </div>
        <div class="stat-card wip">
          <h4>WIP</h4>
          <div class="stat-value" id="serviceWipCount">0</div>
        </div>
        <div class="stat-card wip-comp">
          <h4>WIP COMP</h4>
          <div class="stat-value" id="serviceWipCompCount">0</div>
        </div>
        <div class="stat-card wip-tech">
          <h4>WIP TECH</h4>
          <div class="stat-value" id="serviceWipTechCount">0</div>
        </div>
      </div>

      <h3><i class="fas fa-file-excel"></i> Import File Excel</h3>
      <input type="file" id="importService" accept=".xlsx,.xls,.csv" onchange="importServiceExcel()" />
      
      <!-- Download Excel -->
      <div class="file-actions">
        <button class="btn btn-success" onclick="exportServiceToExcel()">
          <i class="fas fa-download"></i> Download Excel
        </button>
      </div>
      
      <!-- Filter Section -->
      <div class="filter-section">
        <h4><i class="fas fa-filter"></i> Filter Data</h4>
        <div class="filter-row">
          <div class="filter-group">
            <label for="searchService"><i class="fas fa-search"></i> Cari:</label>
            <input type="text" id="searchService" placeholder="Nomor Service Call / Nama Pemilik" onkeyup="applyServiceFilter()" />
          </div>
          <div class="filter-group">
            <label for="filterStatus"><i class="fas fa-tasks"></i> Status:</label>
            <select id="filterStatus" onchange="applyServiceFilter()">
              <option value="all">SEMUA</option>
              <option value="CANCELED">CANCELED</option>
              <option value="INVOICED">INVOICED</option>
              <option value="COMPLETED">COMPLETED</option>
              <option value="PRINTED">PRINTED</option>
              <option value="WIP">WIP</option>
              <option value="WIP COMP">WIP COMP</option>
              <option value="WIP TECH">WIP TECH</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterTeknisiService"><i class="fas fa-user"></i> Nama Teknisi:</label>
            <select id="filterTeknisiService" onchange="applyServiceFilter()">
              <option value="all">SEMUA</option>
              <option value="Harmindo Lamma">Harmindo Lamma</option>
              <option value="Yandri Ottu">Yandri Ottu</option>
              <option value="Rizaldi Abdullah">Rizaldi Abdullah</option>
              <option value="Inosencius A.v. Faot">Inosencius A.v. Faot</option>
            </select>
          </div>
          <button class="clear-filters" onclick="clearServiceFilters()">
            <i class="fas fa-times"></i> Hapus Filter
          </button>
        </div>
      </div>
      
      <!-- Wrapper untuk tabel dan tools -->
      <div class="table-wrapper">
        <!-- Tabel dengan container -->
        <div class="table-container">
          <table id="serviceTable">
            <thead>
              <tr>
                <th>Tanggal Pendaftaran</th>
                <th>Nomor Service Call</th>
                <th>Jenis Layanan</th>
                <th>Jenis Garansi</th>
                <th>Tipe Demand</th>
                <th>Nomor Seri</th>
                <th>Nama Pemilik</th>
                <th>Alamat Pemilik</th>
                <th>Status Pengerjaan</th>
                <th>Nama Teknisi</th>
                <th>Tanggal Serah Terima</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="pagination">
        <div class="pagination-controls">
          <button id="prevService" onclick="prevServicePage()"><i class="fas fa-arrow-left"></i> Back</button>
        </div>
        <div class="pagination-info">
          <span id="pageInfoService"></span>
        </div>
        <div class="rows-per-page">
          <label for="rowsPerPageService">Baris per halaman:</label>
          <select id="rowsPerPageService" onchange="changeRowsPerPageService()">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
          <button id="nextService" onclick="nextServicePage()">Next <i class="fas fa-arrow-right"></i></button>
        </div>
      </div>
    </div>

    <!-- PENGATURAN -->
    <div id="settings" class="card" style="display:none;">
      <h2><i class="fas fa-cog"></i> Pengaturan</h2>
      
      <div class="settings-section">
        <h3><i class="fas fa-image"></i> Upload Logo</h3>
        <input type="file" id="logoInput" accept="image/*" onchange="changeLogo()" />
        <p>Logo yang diupload akan tampil di bagian header dashboard.</p>
      </div>
      
      <div class="settings-section">
        <h3><i class="fas fa-database"></i> Pengaturan Database</h3>
        <p>Pengaturan koneksi dan manajemen database.</p>
      </div>
      
      <div class="settings-section">
        <h3><i class="fas fa-user-cog"></i> Pengaturan Pengguna</h3>
        <p>Kelola pengguna, hak akses, dan izin.</p>
      </div>
      
      <div class="settings-section">
        <h3><i class="fas fa-bell"></i> Notifikasi</h3>
        <p>Konfigurasi notifikasi dan pengingat sistem.</p>
      </div>
      
      <div class="settings-section">
        <h3><i class="fas fa-save"></i> Penyimpanan Data</h3>
        <p>Data akan otomatis tersimpan di browser (localStorage) setiap kali ada perubahan.</p>
        <div class="file-actions">
          <button class="btn btn-success" onclick="backupData()">
            <i class="fas fa-download"></i> Backup Data
          </button>
          <label for="restoreFile" class="btn">
            <i class="fas fa-upload"></i> Restore Data
          </label>
          <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(event)">
          <button class="btn btn-danger" onclick="clearAllData()">Hapus Semua Data Tersimpan</button>
        </div>
      </div>
    </div>

    <!-- LOGOUT -->
    <div id="logout" class="card" style="display:none;">
      <h2><i class="fas fa-sign-out-alt"></i> Logout</h2>
      <p>Anda telah keluar dari sistem.</p>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>

  <script>
    // ---- GLOBAL FUNCTION ----
    function showPage(pageId) {
      const pages = document.querySelectorAll('.card');
      pages.forEach(p => p.style.display = "none");
      document.getElementById(pageId).style.display = "block";
      
      // Update statistics when switching pages
      updateStatistics();
    }

    // ---- NOTIFICATION ----
    function showNotification(message, duration = 3000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, duration);
    }

    // ---- LOADING OVERLAY ----
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // ---- LOCAL STORAGE MANAGEMENT ----
    function saveToLocalStorage(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
        showNotification('Data berhasil disimpan!');
      } catch (e) {
        console.error('Gagal menyimpan data ke localStorage:', e);
        showNotification('Gagal menyimpan data!', 5000);
      }
    }

    function loadFromLocalStorage(key, defaultValue = []) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch (e) {
        console.error('Gagal memuat data dari localStorage:', e);
        return defaultValue;
      }
    }

    function clearAllData() {
      if (confirm('Apakah Anda yakin ingin menghapus semua data tersimpan?')) {
        localStorage.removeItem('masterData');
        localStorage.removeItem('stockData');
        localStorage.removeItem('reservasiData');
        localStorage.removeItem('serviceData');
        showNotification('Semua data berhasil dihapus!');
        
        // Reset data di memori
        masterData = [];
        filteredMaster = [];
        allData = [];
        filteredStock = [];
        reservasiData = [];
        filteredReservasi = [];
        serviceData = [];
        filteredService = [];
        
        // Update statistics
        updateStatistics();
        
        // Render ulang tabel
        if (document.getElementById('master').style.display !== 'none') {
          renderMasterTable();
        } else if (document.getElementById('stock').style.display !== 'none') {
          renderTable();
        } else if (document.getElementById('reservasi').style.display !== 'none') {
          renderReservasiTable();
        } else if (document.getElementById('service').style.display !== 'none') {
          renderServiceTable();
        }
      }
    }

    // ---- BACKUP AND RESTORE ----
    function backupData() {
      const backup = {
        masterData: masterData,
        stockData: allData,
        reservasiData: reservasiData,
        serviceData: serviceData,
        timestamp: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(backup);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `dashboard_backup_${new Date().toISOString().slice(0,10)}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showNotification('Data backup berhasil!');
    }

    function restoreData(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const backup = JSON.parse(e.target.result);
          
          if (confirm('Restore backup akan menimpa data saat ini. Lanjutkan?')) {
            masterData = backup.masterData || [];
            allData = backup.stockData || [];
            reservasiData = backup.reservasiData || [];
            serviceData = backup.serviceData || [];
            
            // Save to localStorage
            saveToLocalStorage('masterData', masterData);
            saveToLocalStorage('stockData', allData);
            saveToLocalStorage('reservasiData', reservasiData);
            saveToLocalStorage('serviceData', serviceData);
            
            // Refresh current display
            loadDataFromStorage();
            updateStatistics();
            
            showNotification('Data berhasil dipulihkan!');
          }
        } catch (error) {
          showNotification('Restore gagal: File backup tidak valid!', 5000);
        }
      };
      
      reader.readAsText(file);
    }

    // ---- STATISTICS ----
    function updateStatistics() {
      // Master components statistics
      document.getElementById('masterTotalCount').textContent = masterData.length;
      
      // Stock statistics
      let totalQty = 0;
      let totalAlloc = 0;
      let totalAvailable = 0;
      
      allData.forEach(row => {
        totalQty += parseInt(row[stockIndexMap[5]]) || 0;
        totalAlloc += parseInt(row[stockIndexMap[6]]) || 0;
        totalAvailable += parseInt(row[stockIndexMap[7]]) || 0;
      });
      
      document.getElementById('stockTotalCount').textContent = totalQty;
      document.getElementById('stockAllocCount').textContent = totalAlloc;
      document.getElementById('stockAvailableCount').textContent = totalAvailable;
      
      // Reservasi statistics
      let totalReservasiQty = 0;
      let totalCloseQty = 0;
      
      reservasiData.forEach(row => {
        totalReservasiQty += parseInt(row[reservasiIndexMap[3]]) || 0;
        totalCloseQty += parseInt(row[reservasiIndexMap[5]]) || 0;
      });
      
      document.getElementById('reservasiTotalCount').textContent = reservasiData.length;
      document.getElementById('reservasiQtyCount').textContent = totalReservasiQty;
      document.getElementById('reservasiCloseCount').textContent = totalCloseQty;
      
      // Service statistics - Updated for all status types
      let totalCount = 0;
      let canceledCount = 0;
      let invoicedCount = 0;
      let completedCount = 0;
      let printedCount = 0;
      let wipCount = 0;
      let wipCompCount = 0;
      let wipTechCount = 0;
      
      serviceData.forEach(row => {
        const status = row[serviceIndexMap[8]] || "";
        totalCount++;
        
        if (status.toUpperCase() === 'CANCELED') {
          canceledCount++;
        } else if (status.toUpperCase() === 'INVOICED') {
          invoicedCount++;
        } else if (status.toUpperCase() === 'COMPLETED') {
          completedCount++;
        } else if (status.toUpperCase() === 'PRINTED') {
          printedCount++;
        } else if (status.toUpperCase() === 'WIP') {
          wipCount++;
        } else if (status.toUpperCase() === 'WIP COMP') {
          wipCompCount++;
        } else if (status.toUpperCase() === 'WIP TECH') {
          wipTechCount++;
        }
      });
      
      // Update all status statistics
      document.getElementById('serviceTotalCount').textContent = totalCount;
      document.getElementById('serviceCanceledCount').textContent = canceledCount;
      document.getElementById('serviceInvoicedCount').textContent = invoicedCount;
      document.getElementById('serviceCompletedCount').textContent = completedCount;
      document.getElementById('servicePrintedCount').textContent = printedCount;
      document.getElementById('serviceWipCount').textContent = wipCount;
      document.getElementById('serviceWipCompCount').textContent = wipCompCount;
      document.getElementById('serviceWipTechCount').textContent = wipTechCount;
    }

    // ---- DATA VALIDATION ----
    function validateMasterData(data) {
      const errors = [];
      data.forEach((row, index) => {
        if (!row[0]) errors.push(`Baris ${index + 1}: Part Number tidak boleh kosong`);
        if (!row[1]) errors.push(`Baris ${index + 1}: Description tidak boleh kosong`);
      });
      
      if (errors.length > 0) {
        showNotification(`Validasi gagal: ${errors.join(', ')}`, 5000);
        return false;
      }
      return true;
    }

    function validateStockData(data) {
      const errors = [];
      data.forEach((row, index) => {
        if (!row[1]) errors.push(`Baris ${index + 1}: Tipe Lokasi tidak boleh kosong`);
        if (!row[2]) errors.push(`Baris ${index + 1}: Nama tidak boleh kosong`);
        if (!row[3]) errors.push(`Baris ${index + 1}: Part tidak boleh kosong`);
      });
      
      if (errors.length > 0) {
        showNotification(`Validasi gagal: ${errors.join(', ')}`, 5000);
        return false;
      }
      return true;
    }

    // ---- EXPORT TO EXCEL ----
    function exportStockToExcel() {
      if (filteredStock.length === 0) {
        showNotification('Tidak ada data untuk diekspor!', 5000);
        return;
      }

      showLoading();
      
      try {
        // Buat workbook baru
        const wb = XLSX.utils.book_new();
        
        // Buat worksheet dari data
        const ws = XLSX.utils.json_to_sheet(filteredStock.map((row, index) => {
          return {
            "No.": index + 1,
            "Tipe Lokasi": row[stockIndexMap[1]] || "",
            "Nama": row[stockIndexMap[2]] || "",
            "Part": row[stockIndexMap[3]] || "",
            "Deskripsi Part": row[stockIndexMap[4]] || "",
            "QTY": row[stockIndexMap[5]] || "",
            "QTY Alloc": row[stockIndexMap[6]] || "",
            "Available QTY": row[stockIndexMap[7]] || "",
            "Return To Factory": row[stockIndexMap[8]] || ""
          };
        }));
        
        // Tambahkan worksheet ke workbook
        XLSX.utils.book_append_sheet(wb, ws, "Stock Komponen");
        
        // Generate nama file dengan timestamp
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        const fileName = `Data_Stock_Komponen_${timestamp}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, fileName);
        
        showNotification('Data berhasil diekspor ke Excel!');
      } catch (error) {
        console.error('Export error:', error);
        showNotification('Gagal mengekspor data ke Excel!', 5000);
      } finally {
        hideLoading();
      }
    }

    // ---- EXPORT RESERVASI TO EXCEL ----
    function exportReservasiToExcel() {
      if (filteredReservasi.length === 0) {
        showNotification('Tidak ada data untuk diekspor!', 5000);
        return;
      }

      showLoading();
      
      try {
        // Buat workbook baru
        const wb = XLSX.utils.book_new();
        
        // Buat worksheet dari data
        const ws = XLSX.utils.json_to_sheet(filteredReservasi.map((row, index) => {
          return {
            "No.": index + 1,
            "Nomor": row[reservasiIndexMap[0]] || "",
            "Catatan": row[reservasiIndexMap[1]] || "",
            "Part": row[reservasiIndexMap[2]] || "",
            "Qty Reservasi": row[reservasiIndexMap[3]] || "",
            "Qty Transaksi": row[reservasiIndexMap[4]] || "",
            "Qty Close": row[reservasiIndexMap[5]] || "",
            "Part Demand": row[reservasiIndexMap[6]] || "",
            "Serial Number": row[reservasiIndexMap[7]] || "",
            "Return To Factory": row[reservasiIndexMap[8]] || "",
            "Teknisi Perbaikan": row[reservasiIndexMap[9]] || "",
            "Analisa SA": row[reservasiIndexMap[10]] || "",
            "Disetujui Pada": formatDateTime(row[reservasiIndexMap[11]])
          };
        }));
        
        // Tambahkan worksheet ke workbook
        XLSX.utils.book_append_sheet(wb, ws, "Reservasi Komponen");
        
        // Generate nama file dengan timestamp
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        const fileName = `Data_Reservasi_Komponen_${timestamp}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, fileName);
        
        showNotification('Data reservasi berhasil diekspor ke Excel!');
      } catch (error) {
        console.error('Export error:', error);
        showNotification('Gagal mengekspor data reservasi ke Excel!', 5000);
      } finally {
        hideLoading();
      }
    }

    // ---- EXPORT SERVICE TO EXCEL ----
    function exportServiceToExcel() {
      if (filteredService.length === 0) {
        showNotification('Tidak ada data untuk diekspor!', 5000);
        return;
      }

      showLoading();
      
      try {
        // Buat workbook baru
        const wb = XLSX.utils.book_new();
        
        // Buat worksheet dari data
        const ws = XLSX.utils.json_to_sheet(filteredService.map((row, index) => {
          return {
            "No.": index + 1,
            "Tanggal Pendaftaran": formatDateOnly(row[serviceIndexMap[0]]),
            "Nomor Service Call": row[serviceIndexMap[1]] || "",
            "Jenis Layanan": row[serviceIndexMap[2]] || "",
            "Jenis Garansi": row[serviceIndexMap[3]] || "",
            "Tipe Demand": row[serviceIndexMap[4]] || "",
            "Nomor Seri": row[serviceIndexMap[5]] || "",
            "Nama Pemilik": row[serviceIndexMap[6]] || "",
            "Alamat Pemilik": row[serviceIndexMap[7]] || "",
            "Status Pengerjaan": row[serviceIndexMap[8]] || "",
            "Nama Teknisi": row[serviceIndexMap[9]] || "",
            "Tanggal Serah Terima": formatDateTime(row[serviceIndexMap[10]])
          };
        }));
        
        // Tambahkan worksheet ke workbook
        XLSX.utils.book_append_sheet(wb, ws, "Service Calls");
        
        // Generate nama file dengan timestamp
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        const fileName = `Data_Service_Calls_${timestamp}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, fileName);
        
        showNotification('Data service calls berhasil diekspor ke Excel!');
      } catch (error) {
        console.error('Export error:', error);
        showNotification('Gagal mengekspor data service calls ke Excel!', 5000);
      } finally {
        hideLoading();
      }
    }

    // ---- LOGO ----
    function changeLogo() {
      const file = document.getElementById("logoInput").files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById("logo").src = e.target.result;
          localStorage.setItem("dashboardLogo", e.target.result); // simpan di local storage
        };
        reader.readAsDataURL(file);
      }
    }

    // ---- FUNGSI FORMAT TANGGAL ----
    function formatDateTime(dateString) {
      if (!dateString) return "";
      
      // Jika dateString adalah objek Date Excel (angka)
      if (typeof dateString === 'number') {
        const date = new Date((dateString - 25569) * 86400 * 1000);
        return formatDateObject(date);
      }
      
      // Coba parsing sebagai string tanggal
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return dateString; // Kembalikan asli jika tidak bisa diparsing
      }
      
      return formatDateObject(date);
    }
    
    function formatDateObject(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }
    
    // ---- FUNGSI FORMAT TANGGAL SAJA (tanpa jam) ----
    function formatDateOnly(dateString) {
      if (!dateString) return "";
      
      // Jika dateString adalah objek Date Excel (angka)
      if (typeof dateString === 'number') {
        const date = new Date((dateString - 25569) * 86400 * 1000);
        return formatDateOnlyObject(date);
      }
      
      // Coba parsing sebagai string tanggal
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return dateString; // Kembalikan asli jika tidak bisa diparsing
      }
      
      return formatDateOnlyObject(date);
    }
    
    function formatDateOnlyObject(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      return `${day}/${month}/${year}`;
    }

    // ---- MASTER KOMPONEN ----
    let masterData = [];
    let filteredMaster = [];
    let currentMasterPage = 1;
    let rowsPerPageMaster = 15;

    function importMasterExcel() {
      const file = document.getElementById('importMaster').files[0];
      if (!file) return;
      
      showLoading();
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, {header:1});

          const headers = ["No.","Part Number","Description"];
          const excelHeaders = json[0].map(h => h.toString().trim());
          let indexMap = headers.map(h => excelHeaders.indexOf(h));

          const tempData = json.slice(1).filter(r => r.length > 0).map(r => [
            r[indexMap[1]] || "",
            r[indexMap[2]] || ""
          ]);

          if (!validateMasterData(tempData)) {
            hideLoading();
            return;
          }

          masterData = tempData;
          saveToLocalStorage('masterData', masterData);
          
          updatePartFilter(masterData);
          filteredMaster = masterData;
          currentMasterPage = 1;
          renderMasterTable();
          updateStatistics();
        } catch (error) {
          console.error('Import error:', error);
          showNotification('Gagal mengimpor file Excel!', 5000);
        } finally {
          hideLoading();
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function updatePartFilter(data) {
      const select = document.getElementById("filterPart");
      select.innerHTML = '<option value="all">Semua</option>';
      const initials = new Set();
      data.forEach(row => {
        if (row[0]) initials.add(row[0].toString().charAt(0).toUpperCase());
      });
      [...initials].sort().forEach(l => {
        let opt = document.createElement("option");
        opt.value = l;
        opt.textContent = l;
        select.appendChild(opt);
      });
    }

    function renderMasterTable() {
      const tbody = document.getElementById("masterTable").querySelector("tbody");
      tbody.innerHTML = "";

      const start = (currentMasterPage - 1) * rowsPerPageMaster;
      const end = start + rowsPerPageMaster;
      const pageData = filteredMaster.slice(start, end);

      pageData.forEach((row, i) => {
        let newRow = tbody.insertRow();
        
        // Kolom No. (rata tengah)
        let cellNo = newRow.insertCell();
        cellNo.textContent = start + i + 1;
        cellNo.className = "text-center";
        
        // Kolom Part Number (rata kiri)
        let cellPart = newRow.insertCell();
        cellPart.textContent = row[0];
        cellPart.className = "text-left";
        
        // Kolom Description (rata kiri)
        let cellDesc = newRow.insertCell();
        cellDesc.textContent = row[1];
        cellDesc.className = "text-left";
      });

      document.getElementById("pageInfoMaster").textContent =
        `Halaman ${currentMasterPage} dari ${Math.ceil(filteredMaster.length / rowsPerPageMaster)}`;

      document.getElementById("prevMaster").disabled = currentMasterPage === 1;
      document.getElementById("nextMaster").disabled = end >= filteredMaster.length;
    }

    function applyMasterFilter() {
      const searchVal = document.getElementById("searchMaster").value.toLowerCase();
      const filterVal = document.getElementById("filterPart").value;

      filteredMaster = masterData;

      if (filterVal !== "all") {
        filteredMaster = filteredMaster.filter(r => r[0].toString().toUpperCase().startsWith(filterVal));
      }

      if (searchVal) {
        filteredMaster = filteredMaster.filter(r => {
          return (
            (r[0] && r[0].toString().toLowerCase().includes(searchVal)) ||
            (r[1] && r[1].toString().toLowerCase().includes(searchVal))
          );
        });
      }

      currentMasterPage = 1;
      renderMasterTable();
    }

    function prevMasterPage() {
      if (currentMasterPage > 1) {
        currentMasterPage--;
        renderMasterTable();
      }
    }

    function nextMasterPage() {
      if (currentMasterPage * rowsPerPageMaster < filteredMaster.length) {
        currentMasterPage++;
        renderMasterTable();
      }
    }

    function changeRowsPerPageMaster() {
      rowsPerPageMaster = parseInt(document.getElementById("rowsPerPageMaster").value);
      currentMasterPage = 1;
      renderMasterTable();
    }

    // ---- STOCK KOMPONEN ----
    let stockIndexMap = [];
    let allData = [];
    let filteredStock = [];
    let currentStockPage = 1;
    let rowsPerPageStock = 15;

    function importExcel() {
      const file = document.getElementById('importFile').files[0];
      if (!file) return;
      
      showLoading();
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, {header:1});

          const headers = ["No.","Tipe Lokasi","Nama","Part","Deskripsi Part","QTY","QTY Alloc","Available QTY","Return To Factory"];
          const excelHeaders = json[0].map(h => h.toString().trim());
          stockIndexMap = headers.map(h => excelHeaders.indexOf(h));

          const tempData = json.slice(1).filter(r => r.length > 0);
          
          if (!validateStockData(tempData)) {
            hideLoading();
            return;
          }

          allData = tempData;
          saveToLocalStorage('stockData', allData);
          
          filteredStock = allData;

          updateFilterOptions(allData);
          currentStockPage = 1;
          renderTable();
          updateStatistics();
        } catch (error) {
          console.error('Import error:', error);
          showNotification('Gagal mengimpor file Excel!', 5000);
        } finally {
          hideLoading();
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function renderTable() {
      const tbody = document.getElementById("stockTable").querySelector("tbody");
      tbody.innerHTML = "";

      const start = (currentStockPage - 1) * rowsPerPageStock;
      const end = start + rowsPerPageStock;
      const pageData = filteredStock.slice(start, end);

      pageData.forEach((row, i) => {
        let newRow = tbody.insertRow();
        
        // Kolom No. (rata tengah)
        let cellNo = newRow.insertCell();
        cellNo.textContent = start + i + 1;
        cellNo.className = "text-center";
        
        // Kolom Tipe Lokasi (rata tengah)
        let cellTipe = newRow.insertCell();
        cellTipe.textContent = row[stockIndexMap[1]] || "";
        cellTipe.className = "text-center";
        
        // Kolom Nama (rata kiri)
        let cellNama = newRow.insertCell();
        cellNama.textContent = row[stockIndexMap[2]] || "";
        cellNama.className = "text-left";
        
        // Kolom Part (rata kiri)
        let cellPart = newRow.insertCell();
        cellPart.textContent = row[stockIndexMap[3]] || "";
        cellPart.className = "text-left";
        
        // Kolom Deskripsi Part (rata kiri)
        let cellDesc = newRow.insertCell();
        cellDesc.textContent = row[stockIndexMap[4]] || "";
        cellDesc.className = "text-left";
        
        // Kolom QTY (rata tengah)
        let cellQty = newRow.insertCell();
        cellQty.textContent = row[stockIndexMap[5]] || "";
        cellQty.className = "text-center";
        
        // Kolom QTY Alloc (rata tengah)
        let cellAlloc = newRow.insertCell();
        cellAlloc.textContent = row[stockIndexMap[6]] || "";
        cellAlloc.className = "text-center";
        
        // Kolom Available QTY (rata tengah)
        let cellAvailable = newRow.insertCell();
        cellAvailable.textContent = row[stockIndexMap[7]] || "";
        cellAvailable.className = "text-center";
        
        // Kolom Return To Factory (rata tengah)
        let cellReturn = newRow.insertCell();
        cellReturn.textContent = row[stockIndexMap[8]] || "";
        cellReturn.className = "text-center";
      });

      document.getElementById("pageInfo").textContent =
        `Halaman ${currentStockPage} dari ${Math.ceil(filteredStock.length / rowsPerPageStock)}`;

      document.getElementById("prevBtn").disabled = currentStockPage === 1;
      document.getElementById("nextBtn").disabled = end >= filteredStock.length;
    }

    function updateFilterOptions(data) {
      const lokasiSet = new Set();
      data.forEach(row => {
        const val = row[stockIndexMap[1]];
        if (val) lokasiSet.add(val);
      });

      const select = document.getElementById("filterLokasi");
      select.innerHTML = '<option value="all">Semua</option>';
      lokasiSet.forEach(l => {
        let opt = document.createElement("option");
        opt.value = l;
        opt.textContent = l;
        select.appendChild(opt);
      });
    }

    function applyFilter() {
      const filterVal = document.getElementById("filterLokasi").value;
      const searchVal = document.getElementById("searchInput").value.toLowerCase();

      filteredStock = allData;

      if (filterVal !== "all") {
        filteredStock = filteredStock.filter(r => r[stockIndexMap[1]] == filterVal);
      }

      if (searchVal) {
        filteredStock = filteredStock.filter(r => {
          return (
            (r[stockIndexMap[2]] && r[stockIndexMap[2]].toString().toLowerCase().includes(searchVal)) ||
            (r[stockIndexMap[3]] && r[stockIndexMap[3]].toString().toLowerCase().includes(searchVal)) ||
            (r[stockIndexMap[4]] && r[stockIndexMap[4]].toString().toLowerCase().includes(searchVal))
          );
        });
      }

      currentStockPage = 1;
      renderTable();
    }

    function prevPage() {
      if (currentStockPage > 1) {
        currentStockPage--;
        renderTable();
      }
    }

    function nextPage() {
      if (currentStockPage * rowsPerPageStock < filteredStock.length) {
        currentStockPage++;
        renderTable();
      }
    }

    function changeRowsPerPage() {
      rowsPerPageStock = parseInt(document.getElementById("rowsPerPage").value);
      currentStockPage = 1;
      renderTable();
    }

    // ---- RESERVASI ----
    let reservasiData = [];
    let reservasiIndexMap = [];
    let filteredReservasi = [];
    let currentReservasiPage = 1;
    let rowsPerPageReservasi = 15;

    function importReservasiExcel() {
      const file = document.getElementById('importReservasi').files[0];
      if (!file) return;
      
      showLoading();
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, {header:1});

          const headers = ["Nomor","Catatan","Part","Qty Reservasi","Qty Transaksi","Qty Close","Part Demand","Serial Number","Return To Factory","Teknisi Perbaikan","Analisa SA","Disetujui Pada"];
          const excelHeaders = json[0].map(h => h.toString().trim());
          reservasiIndexMap = headers.map(h => excelHeaders.indexOf(h));

          reservasiData = json.slice(1).filter(r => r.length > 0);
          saveToLocalStorage('reservasiData', reservasiData);
          
          filteredReservasi = reservasiData;
          currentReservasiPage = 1;
          
          updateTeknisiFilter(reservasiData);
          renderReservasiTable();
          updateStatistics();
        } catch (error) {
          console.error('Import error:', error);
          showNotification('Gagal mengimpor file Excel!', 5000);
        } finally {
          hideLoading();
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function updateTeknisiFilter(data) {
      const teknisiSet = new Set();
      data.forEach(row => {
        const val = row[reservasiIndexMap[9]]; // Teknisi Perbaikan
        if (val) teknisiSet.add(val);
      });

      const select = document.getElementById("filterTeknisi");
      select.innerHTML = '<option value="all">Semua</option>';
      [...teknisiSet].sort().forEach(t => {
        let opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        select.appendChild(opt);
      });
    }

    function renderReservasiTable() {
      const tbody = document.getElementById("reservasiTable").querySelector("tbody");
      tbody.innerHTML = "";

      const start = (currentReservasiPage - 1) * rowsPerPageReservasi;
      const end = start + rowsPerPageReservasi;
      const pageData = filteredReservasi.slice(start, end);

      pageData.forEach((row, i) => {
        let newRow = tbody.insertRow();
        
        // Kolom Nomor (rata tengah)
        let cellNomor = newRow.insertCell();
        cellNomor.textContent = row[reservasiIndexMap[0]] || "";
        cellNomor.className = "text-center";
        
        // Kolom Catatan (rata kiri)
        let cellCatatan = newRow.insertCell();
        cellCatatan.textContent = row[reservasiIndexMap[1]] || "";
        cellCatatan.className = "text-left";
        
        // Kolom Part (rata kiri)
        let cellPart = newRow.insertCell();
        cellPart.textContent = row[reservasiIndexMap[2]] || "";
        cellPart.className = "text-left";
        
        // Kolom Qty Reservasi (rata tengah)
        let cellQtyReservasi = newRow.insertCell();
        cellQtyReservasi.textContent = row[reservasiIndexMap[3]] || "";
        cellQtyReservasi.className = "text-center";
        
        // Kolom Qty Transaksi (rata tengah)
        let cellQtyTransaksi = newRow.insertCell();
        cellQtyTransaksi.textContent = row[reservasiIndexMap[4]] || "";
        cellQtyTransaksi.className = "text-center";
        
        // Kolom Qty Close (rata tengah)
        let cellQtyClose = newRow.insertCell();
        cellQtyClose.textContent = row[reservasiIndexMap[5]] || "";
        cellQtyClose.className = "text-center";
        
        // Kolom Part Demand (rata kiri)
        let cellPartDemand = newRow.insertCell();
        cellPartDemand.textContent = row[reservasiIndexMap[6]] || "";
        cellPartDemand.className = "text-left";
        
        // Kolom Serial Number (rata kiri) - Highlight jika ada filter
        let cellSerial = newRow.insertCell();
        const serialValue = row[reservasiIndexMap[7]] || "";
        cellSerial.textContent = serialValue;
        cellSerial.className = "text-left";
        
        // Highlight serial number jika sesuai dengan filter
        const filterSerial = document.getElementById("filterSerial").value.trim();
        if (filterSerial && serialValue.toLowerCase().includes(filterSerial.toLowerCase())) {
          cellSerial.style.backgroundColor = "#fff3cd";
          cellSerial.style.fontWeight = "bold";
        }
        
        // Kolom Return To Factory (rata tengah)
        let cellReturn = newRow.insertCell();
        cellReturn.textContent = row[reservasiIndexMap[8]] || "";
        cellReturn.className = "text-center";
        
        // Kolom Teknisi Perbaikan (rata kiri)
        let cellTeknisi = newRow.insertCell();
        cellTeknisi.textContent = row[reservasiIndexMap[9]] || "";
        cellTeknisi.className = "text-left";
        
        // Kolom Analisa SA (rata kiri)
        let cellAnalisa = newRow.insertCell();
        cellAnalisa.textContent = row[reservasiIndexMap[10]] || "";
        cellAnalisa.className = "text-left";
        
        // Kolom Disetujui Pada (rata tengah) dengan format tanggal
        let cellDisetujui = newRow.insertCell();
        const tanggalValue = row[reservasiIndexMap[11]] || "";
        cellDisetujui.textContent = formatDateTime(tanggalValue);
        cellDisetujui.className = "text-center";
      });

      document.getElementById("pageInfoReservasi").textContent =
        `Halaman ${currentReservasiPage} dari ${Math.ceil(filteredReservasi.length / rowsPerPageReservasi)}`;

      document.getElementById("prevReservasi").disabled = currentReservasiPage === 1;
      document.getElementById("nextReservasi").disabled = end >= filteredReservasi.length;
    }

    function applyReservasiFilter() {
      const searchVal = document.getElementById("searchReservasi").value.toLowerCase();
      const filterTeknisi = document.getElementById("filterTeknisi").value;
      const filterSerial = document.getElementById("filterSerial").value.toLowerCase().trim();

      filteredReservasi = reservasiData;

      // Filter berdasarkan Teknisi Perbaikan
      if (filterTeknisi !== "all") {
        filteredReservasi = filteredReservasi.filter(r => {
          const teknisi = r[reservasiIndexMap[9]] || "";
          return teknisi === filterTeknisi;
        });
      }

      // Filter berdasarkan Serial Number
      if (filterSerial) {
        filteredReservasi = filteredReservasi.filter(r => {
          const serial = r[reservasiIndexMap[7]] || "";
          return serial.toLowerCase().includes(filterSerial);
        });
      }

      // Filter berdasarkan pencarian
      if (searchVal) {
        filteredReservasi = filteredReservasi.filter(r => {
          return (
            (r[reservasiIndexMap[0]] && r[reservasiIndexMap[0]].toString().toLowerCase().includes(searchVal)) ||
            (r[reservasiIndexMap[1]] && r[reservasiIndexMap[1]].toString().toLowerCase().includes(searchVal)) ||
            (r[reservasiIndexMap[2]] && r[reservasiIndexMap[2]].toString().toLowerCase().includes(searchVal))
          );
        });
      }

      currentReservasiPage = 1;
      renderReservasiTable();
    }

    function clearReservasiFilters() {
      // Clear all filter inputs
      document.getElementById("searchReservasi").value = "";
      document.getElementById("filterTeknisi").value = "all";
      document.getElementById("filterSerial").value = "";
      
      // Reset filtered data
      filteredReservasi = reservasiData;
      currentReservasiPage = 1;
      renderReservasiTable();
      
      showNotification("Filter berhasil dihapus!");
    }

    function prevReservasiPage() {
      if (currentReservasiPage > 1) {
        currentReservasiPage--;
        renderReservasiTable();
      }
    }

    function nextReservasiPage() {
      if (currentReservasiPage * rowsPerPageReservasi < filteredReservasi.length) {
        currentReservasiPage++;
        renderReservasiTable();
      }
    }

    function changeRowsPerPageReservasi() {
      rowsPerPageReservasi = parseInt(document.getElementById("rowsPerPageReservasi").value);
      currentReservasiPage = 1;
      renderReservasiTable();
    }

    // ---- SERVICE CALLS ----
    let serviceData = [];
    let serviceIndexMap = [];
    let filteredService = [];
    let currentServicePage = 1;
    let rowsPerPageService = 15;

    function importServiceExcel() {
      const file = document.getElementById('importService').files[0];
      if (!file) return;
      
      showLoading();
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, {header:1});

          const headers = ["Tanggal Pendaftaran","Nomor Service Call","Jenis Layanan","Jenis Garansi","Tipe Demand","Nomor Seri","Nama Pemilik","Alamat Pemilik","Status Pengerjaan","Nama Teknisi","Tanggal Serah Terima"];
          const excelHeaders = json[0].map(h => h.toString().trim());
          serviceIndexMap = headers.map(h => excelHeaders.indexOf(h));

          serviceData = json.slice(1).filter(r => r.length > 0);
          saveToLocalStorage('serviceData', serviceData);
          
          filteredService = serviceData;
          currentServicePage = 1;
          renderServiceTable();
          updateStatistics();
        } catch (error) {
          console.error('Import error:', error);
          showNotification('Gagal mengimpor file Excel!', 5000);
        } finally {
          hideLoading();
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function renderServiceTable() {
      const tbody = document.getElementById("serviceTable").querySelector("tbody");
      tbody.innerHTML = "";

      const start = (currentServicePage - 1) * rowsPerPageService;
      const end = start + rowsPerPageService;
      const pageData = filteredService.slice(start, end);

      pageData.forEach((row, i) => {
        let newRow = tbody.insertRow();
        
        // Kolom Tanggal Pendaftaran (rata kiri) dengan format tanggal saja
        let cellTanggal = newRow.insertCell();
        const tanggalValue = row[serviceIndexMap[0]] || "";
        cellTanggal.textContent = formatDateOnly(tanggalValue);
        cellTanggal.className = "text-left";
        
        // Kolom Nomor Service Call (rata kiri)
        let cellNomor = newRow.insertCell();
        cellNomor.textContent = row[serviceIndexMap[1]] || "";
        cellNomor.className = "text-left";
        
        // Kolom Jenis Layanan (rata kiri)
        let cellLayanan = newRow.insertCell();
        cellLayanan.textContent = row[serviceIndexMap[2]] || "";
        cellLayanan.className = "text-left";
        
        // Kolom Jenis Garansi (rata kiri)
        let cellGaransi = newRow.insertCell();
        cellGaransi.textContent = row[serviceIndexMap[3]] || "";
        cellGaransi.className = "text-left";
        
        // Kolom Tipe Demand (rata kiri)
        let cellDemand = newRow.insertCell();
        cellDemand.textContent = row[serviceIndexMap[4]] || "";
        cellDemand.className = "text-left";
        
        // Kolom Nomor Seri (rata kiri)
        let cellSeri = newRow.insertCell();
        cellSeri.textContent = row[serviceIndexMap[5]] || "";
        cellSeri.className = "text-left";
        
        // Kolom Nama Pemilik (rata kiri)
        let cellPemilik = newRow.insertCell();
        cellPemilik.textContent = row[serviceIndexMap[6]] || "";
        cellPemilik.className = "text-left";
        
        // Kolom Alamat Pemilik (rata kiri)
        let cellAlamat = newRow.insertCell();
        cellAlamat.textContent = row[serviceIndexMap[7]] || "";
        cellAlamat.className = "text-left";
        
        // Kolom Status Pengerjaan (rata kiri)
        let cellStatus = newRow.insertCell();
        const statusValue = row[serviceIndexMap[8]] || "";
        cellStatus.className = "text-left";
        
        // Tambahkan badge status dengan warna yang sesuai
        if (statusValue) {
          const statusBadge = document.createElement('span');
          statusBadge.className = 'status-badge';
          
          // Menggunakan status yang baru
          const statusUpper = statusValue.toUpperCase();
          if (statusUpper === 'CANCELED') {
            statusBadge.classList.add('status-canceled');
          } else if (statusUpper === 'INVOICED') {
            statusBadge.classList.add('status-invoiced');
          } else if (statusUpper === 'COMPLETED') {
            statusBadge.classList.add('status-completed');
          } else if (statusUpper === 'PRINTED') {
            statusBadge.classList.add('status-printed');
          } else if (statusUpper === 'WIP') {
            statusBadge.classList.add('status-wip');
          } else if (statusUpper === 'WIP COMP') {
            statusBadge.classList.add('status-wip-comp');
          } else if (statusUpper === 'WIP TECH') {
            statusBadge.classList.add('status-wip-tech');
          } else {
            // Default untuk status lainnya
            statusBadge.classList.add('status-pending');
          }
          
          statusBadge.textContent = statusValue;
          cellStatus.innerHTML = '';
          cellStatus.appendChild(statusBadge);
        }
        
        // Kolom Nama Teknisi (rata kiri) - Highlight jika ada filter
        let cellTeknisi = newRow.insertCell();
        const teknisiValue = row[serviceIndexMap[9]] || "";
        cellTeknisi.textContent = teknisiValue;
        cellTeknisi.className = "text-left";
        
        // Highlight nama teknisi jika sesuai dengan filter
        const filterTeknisi = document.getElementById("filterTeknisiService").value;
        if (filterTeknisi !== "all" && teknisiValue === filterTeknisi) {
          cellTeknisi.style.backgroundColor = "#fff3cd";
          cellTeknisi.style.fontWeight = "bold";
        }
        
        // Kolom Tanggal Serah Terima (rata kiri) dengan format tanggal
        let cellSerah = newRow.insertCell();
        const serahValue = row[serviceIndexMap[10]] || "";
        cellSerah.textContent = formatDateTime(serahValue);
        cellSerah.className = "text-left";
      });

      document.getElementById("pageInfoService").textContent =
        `Halaman ${currentServicePage} dari ${Math.ceil(filteredService.length / rowsPerPageService)}`;

      document.getElementById("prevService").disabled = currentServicePage === 1;
      document.getElementById("nextService").disabled = end >= filteredService.length;
    }

    function applyServiceFilter() {
      const searchVal = document.getElementById("searchService").value.toLowerCase();
      const filterStatus = document.getElementById("filterStatus").value;
      const filterTeknisi = document.getElementById("filterTeknisiService").value;

      filteredService = serviceData;

      // Filter berdasarkan Status Pengerjaan
      if (filterStatus !== "all") {
        filteredService = filteredService.filter(r => {
          const status = r[serviceIndexMap[8]] || "";
          return status.toUpperCase() === filterStatus;
        });
      }

      // Filter berdasarkan Nama Teknisi
      if (filterTeknisi !== "all") {
        filteredService = filteredService.filter(r => {
          const teknisi = r[serviceIndexMap[9]] || "";
          return teknisi === filterTeknisi;
        });
      }

      // Filter berdasarkan pencarian
      if (searchVal) {
        filteredService = filteredService.filter(r => {
          return (
            (r[serviceIndexMap[1]] && r[serviceIndexMap[1]].toString().toLowerCase().includes(searchVal)) ||
            (r[serviceIndexMap[6]] && r[serviceIndexMap[6]].toString().toLowerCase().includes(searchVal))
          );
        });
      }

      currentServicePage = 1;
      renderServiceTable();
    }

    function clearServiceFilters() {
      // Clear all filter inputs
      document.getElementById("searchService").value = "";
      document.getElementById("filterStatus").value = "all";
      document.getElementById("filterTeknisiService").value = "all";
      
      // Reset filtered data
      filteredService = serviceData;
      currentServicePage = 1;
      renderServiceTable();
      
      showNotification("Filter berhasil dihapus!");
    }

    function prevServicePage() {
      if (currentServicePage > 1) {
        currentServicePage--;
        renderServiceTable();
      }
    }

    function nextServicePage() {
      if (currentServicePage * rowsPerPageService < filteredService.length) {
        currentServicePage++;
        renderServiceTable();
      }
    }

    function changeRowsPerPageService() {
      rowsPerPageService = parseInt(document.getElementById("rowsPerPageService").value);
      currentServicePage = 1;
      renderServiceTable();
    }

    // ---- DATA LOADING ----
    function loadDataFromStorage() {
      // Load logo
      const savedLogo = localStorage.getItem("dashboardLogo");
      if (savedLogo) document.getElementById("logo").src = savedLogo;
      
      // Load data dari localStorage
      masterData = loadFromLocalStorage('masterData');
      filteredMaster = masterData;
      updatePartFilter(masterData);
      renderMasterTable();
      
      allData = loadFromLocalStorage('stockData');
      filteredStock = allData;
      updateFilterOptions(allData);
      renderTable();
      
      reservasiData = loadFromLocalStorage('reservasiData');
      filteredReservasi = reservasiData;
      updateTeknisiFilter(reservasiData);
      renderReservasiTable();
      
      serviceData = loadFromLocalStorage('serviceData');
      filteredService = serviceData;
      renderServiceTable();
    }

    // load data dari localStorage saat halaman dimuat
    window.onload = function() {
      loadDataFromStorage();
      updateStatistics();
    };
  </script>
</body>
</html>
